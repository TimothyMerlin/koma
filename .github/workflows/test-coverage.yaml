# Workflow derived from https://github.com/r-lib/actions/tree/v2/examples
# Need help debugging build failures? Start at https://github.com/r-lib/actions#where-to-find-help
on:
    workflow_dispatch:
    push:
        tags:
            - "*"

name: test-coverage

jobs:
    test-coverage:
        runs-on: ubuntu-latest
        env:
            GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}

        steps:
            - uses: actions/checkout@v4

            - uses: r-lib/actions/setup-r@v2
              with:
                  use-public-rspm: true

            - uses: r-lib/actions/setup-r-dependencies@v2
              with:
                  extra-packages: any::covr, any::xml2
                  needs: coverage

            - name: Test coverage
              run: |
                  cov <- covr::package_coverage(
                    quiet = FALSE,
                    clean = FALSE,
                    install_path = file.path(normalizePath(Sys.getenv("RUNNER_TEMP"), winslash = "/"), "package")
                  )
                  covr::to_cobertura(cov, file = "cobertura.xml")
              shell: Rscript {0}

            - name: Upload coverage to Codecov
              uses: codecov/codecov-action@v4
              with:
                  fail_ci_if_error: true
                  files: ./cobertura.xml
                  token: ${{ secrets.CODECOV_TOKEN }}
